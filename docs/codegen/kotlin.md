# Kotlin Code Generation

SketchDDD generates idiomatic Kotlin code using data classes and sealed classes.

## Generation

```bash
sketchddd codegen domain.sddd --target kotlin --output ./src/main/kotlin/domain
```

## Features

- **Data classes** for entities and value objects
- **Sealed classes** for sum types
- **Enum classes** for simple enumerations
- **Nullable types** with `?` syntax
- **Immutable lists** with `List<T>`
- **Kotlinx serialization** annotations

## Type Mappings

| SketchDDD | Kotlin Type |
|-----------|-------------|
| `String` | `String` |
| `Int` | `Long` |
| `Float` | `Double` |
| `Bool` | `Boolean` |
| `UUID` | `UUID` |
| `DateTime` | `Instant` |
| `Date` | `LocalDate` |
| `Decimal` | `BigDecimal` |
| `Email` | `String` |
| `List<T>` | `List<T>` |
| `Map<K,V>` | `Map<K, V>` |
| `T?` | `T?` |

## Example Output

### Input

```sddd
context Payments {
  entity Payment {
    id: UUID
    orderId: UUID
    amount: Money
    method: PaymentMethod
    status: PaymentStatus
    processedAt: DateTime?
  }

  value Money {
    amount: Decimal
    currency: Currency
  }

  enum PaymentStatus = Pending | Processing | Completed | Failed | Refunded
  enum PaymentMethod = CreditCard | DebitCard | BankTransfer | Wallet
  enum Currency = USD | EUR | GBP
}
```

### Generated Code

```kotlin
// Generated by SketchDDD
// Context: Payments

package domain.payments

import java.math.BigDecimal
import java.time.Instant
import java.util.UUID
import kotlinx.serialization.Serializable

/**
 * Payment entity
 */
@Serializable
data class Payment(
    val id: UUID,
    val orderId: UUID,
    val amount: Money,
    val method: PaymentMethod,
    val status: PaymentStatus,
    val processedAt: Instant? = null
)

/**
 * Money value object
 */
@Serializable
data class Money(
    val amount: BigDecimal,
    val currency: Currency
)

/**
 * PaymentStatus enumeration
 */
enum class PaymentStatus {
    Pending,
    Processing,
    Completed,
    Failed,
    Refunded
}

/**
 * PaymentMethod enumeration
 */
enum class PaymentMethod {
    CreditCard,
    DebitCard,
    BankTransfer,
    Wallet
}

/**
 * Currency enumeration
 */
enum class Currency {
    USD,
    EUR,
    GBP
}
```

## Sum Types with Sealed Classes

For enums with associated data:

### Input

```sddd
context Shipping {
  enum ShippingMethod {
    Standard { estimatedDays: Int }
    Express { estimatedDays: Int, priority: Bool }
    Pickup { location: String }
    Digital
  }
}
```

### Generated Code

```kotlin
sealed class ShippingMethod {
    data class Standard(val estimatedDays: Long) : ShippingMethod()
    data class Express(val estimatedDays: Long, val priority: Boolean) : ShippingMethod()
    data class Pickup(val location: String) : ShippingMethod()
    object Digital : ShippingMethod()
}
```

## Usage Patterns

### With Spring Boot

```kotlin
@RestController
@RequestMapping("/api/payments")
class PaymentController(
    private val paymentService: PaymentService
) {
    @GetMapping("/{id}")
    fun getPayment(@PathVariable id: UUID): Payment {
        return paymentService.findById(id)
            ?: throw ResponseStatusException(HttpStatus.NOT_FOUND)
    }

    @PostMapping
    fun createPayment(@RequestBody request: CreatePaymentRequest): Payment {
        return paymentService.create(request)
    }
}
```

### With Room/Exposed

```kotlin
@Entity(tableName = "payments")
data class PaymentEntity(
    @PrimaryKey val id: UUID,
    val orderId: UUID,
    val amountValue: BigDecimal,
    val amountCurrency: String,
    val method: String,
    val status: String,
    val processedAt: Instant?
) {
    fun toDomain(): Payment = Payment(
        id = id,
        orderId = orderId,
        amount = Money(amountValue, Currency.valueOf(amountCurrency)),
        method = PaymentMethod.valueOf(method),
        status = PaymentStatus.valueOf(status),
        processedAt = processedAt
    )
}
```

### With Coroutines

```kotlin
interface PaymentRepository {
    suspend fun findById(id: UUID): Payment?
    suspend fun save(payment: Payment): Payment
    suspend fun findByOrderId(orderId: UUID): List<Payment>
}
```

## Gradle Dependencies

```kotlin
dependencies {
    implementation("org.jetbrains.kotlinx:kotlinx-serialization-json:1.6.0")
    implementation("org.jetbrains.kotlinx:kotlinx-datetime:0.5.0")
}
```

## Project Organization

```
src/main/kotlin/
├── domain/
│   ├── payments/
│   │   └── Models.kt     # Generated
│   ├── orders/
│   │   └── Models.kt     # Generated
│   └── users/
│       └── Models.kt     # Generated
├── repository/
│   └── ...
└── service/
    └── ...
```

## Tips

### Extension Functions

Add domain logic via extensions:

```kotlin
fun Payment.canRefund(): Boolean =
    status == PaymentStatus.Completed &&
    processedAt?.let {
        it.plus(30, ChronoUnit.DAYS) > Instant.now()
    } ?: false

fun Money.plus(other: Money): Money {
    require(currency == other.currency) { "Currency mismatch" }
    return copy(amount = amount + other.amount)
}
```

### Value Class for IDs

For stronger typing:

```kotlin
@JvmInline
value class PaymentId(val value: UUID)

@JvmInline
value class OrderId(val value: UUID)
```
